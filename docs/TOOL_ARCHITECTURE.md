# Tool Documentation Architecture

This document explains how tool documentation is structured in Akmatori and provides guidelines for contributors adding new tools.

## Overview

Akmatori uses a layered documentation architecture where each layer has a specific purpose:

```
AGENTS.md (incident level)
    └── Points to skills
            └── SKILL.md (skill level)
                    └── Points to tools.md
                            └── tools.md (tool level) ← SINGLE SOURCE OF TRUTH
```

## File Responsibilities

### AGENTS.md (`.codex/AGENTS.md`)

**Purpose:** High-level incident manager instructions

**Contains:**
- Incident manager role and responsibilities
- Investigation workflow
- Critical instructions: "DO NOT read source files, ls directories, or read .env files"
- Pointer to tools.md for each skill

**Does NOT contain:**
- Tool-specific code examples
- Import statements
- Function documentation

**Generated by:** `generateIncidentAgentsMd()` in `skill_service.go`

---

### SKILL.md (`skills/{skill-name}/SKILL.md`)

**Purpose:** Skill description and user-defined prompt

**Contains:**
- YAML frontmatter (name, description)
- Pointer to tools.md for Quick Start
- User-defined prompt/instructions

**Does NOT contain:**
- Tool-specific code examples
- Import statements
- Function documentation

**Generated by:** `generateSkillMd()` in `skill_service.go`

---

### tools.md (`skills/{skill-name}/references/tools.md`)

**Purpose:** SINGLE SOURCE OF TRUTH for tool usage

**Contains:**
- **Warning box** at top: "This documentation is COMPLETE. DO NOT read source files..."
- Quick Start code for EACH assigned tool
- Tool-specific function examples
- Batch command patterns
- Full function documentation

**Warning Format:**
```markdown
---
## ⚠️ READ THIS FIRST

**This documentation is COMPLETE.** All functions, parameters, and usage examples are below.

**DO NOT:**
- Read source files (ssh.py, config.py, zabbix.py, etc.)
- List directories with `ls`
- Read .env files
- Explore scripts/ folder

**JUST DO:** Copy the Quick Start code below and run it. Configuration auto-loads.

---
```

**Generated by:** `generateToolsDocumentation()` in `skill_service.go`

---

## Key Principles

### 1. Single Source of Truth

**tools.md is the ONLY place with tool-specific Quick Start code.**

This prevents:
- Duplicated/outdated examples
- Wrong tool examples (e.g., SSH examples for Zabbix-only skill)
- Conflicting instructions

### 2. Auto-Generated Based on Assigned Tools

tools.md is generated dynamically based on which tools are actually assigned to the skill. If a skill has only Zabbix, it shows only Zabbix examples.

### 3. Configuration Auto-Loads

Tools automatically load configuration from `.env.{tool_name}` files. Users should NEVER:
- List directories to find config
- Read .env files directly
- Manually configure tools

### 4. No Redundant Exploration

Documentation should eliminate the need for:
- `ls` commands to find paths
- Reading source code
- Trial-and-error imports

### 5. Authoritative Documentation

The tools.md warning is designed to be authoritative so agents trust it completely and don't waste calls exploring the codebase.

---

## Adding a New Tool

When adding a new tool, update `generateToolsDocumentation()` in `skill_service.go`:

```go
switch toolName {
case "ssh":
    sb.WriteString("print(test_connectivity())\n")
    sb.WriteString("print(execute_command('uptime'))\n")
    // ... SSH-specific examples
case "zabbix":
    sb.WriteString("print(get_hosts())\n")
    sb.WriteString("print(get_problems())\n")
    // ... Zabbix-specific examples
case "your_new_tool":
    sb.WriteString("print(your_function())\n")
    // ... Your tool-specific examples
default:
    sb.WriteString("# result = function_name(...)\n")
}
```

### Checklist for New Tools

1. Add tool to `switch` statement in `generateToolsDocumentation()`
2. Include 2-3 common use case examples
3. Add batch pattern if applicable
4. Ensure function names match actual tool exports
5. Test that Quick Start code works when copied directly

---

## File Generation Flow

```
User assigns tool to skill via UI
         ↓
API calls AssignTools()
         ↓
AssignTools() calls generateToolsDocumentation()
         ↓
tools.md is written with tool-specific Quick Start
         ↓
On container startup:
         ↓
RegenerateAllSkillMds() regenerates ALL SKILL.md and tools.md files
         ↓
When incident is created:
         ↓
generateIncidentAgentsMd() creates AGENTS.md
         ↓
skills/ symlinked to /akmatori/skills (shares regenerated tools.md)
```

---

## Troubleshooting

### Quick Start not showing correct tools

Check that tools are properly assigned to the skill in the database. Run:
```sql
SELECT * FROM skill_tools WHERE skill_id = ?;
```

### Duplicate sections in SKILL.md

The `stripResourceInstructions()` function removes auto-generated sections. Check that the marker is correct:
```go
const marker = "## Quick Start"
```

### Agent still reading source files

Ensure tools.md has the warning box at the top. Check `generateToolsDocumentation()` includes:
```go
sb.WriteString("## ⚠️ READ THIS FIRST\n\n")
sb.WriteString("**This documentation is COMPLETE.**...")
```
